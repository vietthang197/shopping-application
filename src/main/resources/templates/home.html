<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org" lang="en"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="bg-gray-100">
<!-- Navbar -->
<header class="bg-white shadow" style="z-index: 900">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <!-- Icon menu ở góc trái -->
        <div class="flex items-center space-x-4">
            <a href="/" class="flex items-center text-gray-800 font-semibold">
                <span class="material-icons mr-2">store</span> Shopping App
            </a>
        </div>
        <!-- Các nút điều hướng với icon -->
        <div class="flex items-center space-x-6">
            <a href="/cart" class="flex items-center text-gray-800 relative">
                <span class="material-icons mr-1">shopping_cart</span> Cart
                <span id="cartCount"
                      th:text="'(' + ${session.cart != null ? session.cart.totalItems : '0'} + ')'"
                      th:class="${session.cart != null && session.cart.totalItems > 0 ? '' : 'hidden'}"
                      class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                </span>
            </a>
            <div class="relative">
                <button type="button"
                        class="flex items-center text-gray-800 hover:text-gray-600 focus:outline-none"
                        id="categories-menu-button"
                        data-dropdown-toggle="categories-dropdown">
                    <span class="material-icons mr-1">inventory_2</span>
                    Product Categories
                    <span class="material-icons text-sm ml-1">arrow_drop_down</span>
                </button>

                <!-- Categories Dropdown menu -->
                <div id="categories-dropdown"
                     class="hidden absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-lg py-1 z-10">
                    <!-- Lặp qua danh sách categories -->
                    <div th:each="category : ${categories}">
                        <a th:href="@{'/product-categories/product/' + ${category.getId()}}"
                           class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                            <span th:text="${category.getName()}"></span>
                        </a>
                    </div>
                </div>
            </div>
            <a href="/order-tracking" class="flex items-center text-gray-800">
                <span class="material-icons mr-1">search</span> Tra cứu đơn hàng
            </a>
            <a sec:authorize="isAnonymous()" href="/login" class="flex items-center text-gray-800">
                <span class="material-icons mr-1">account_circle</span> Login/Register
            </a>
            <!-- Bằng đoạn code dropdown menu sau -->
            <div sec:authorize="isFullyAuthenticated()" class="relative">
                <button type="button"
                        class="flex items-center text-gray-800 hover:text-gray-600 focus:outline-none"
                        id="user-menu-button"
                        aria-expanded="false"
                        data-dropdown-toggle="user-dropdown">
                    <span class="material-icons mr-1">account_circle</span>
                    <span th:text="${#authentication.getName()}" class="mr-1"></span>
                    <span class="material-icons text-sm">arrow_drop_down</span>
                </button>

                <!-- Dropdown menu -->
                <div id="user-dropdown"
                     class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-10">
                    <a href="/profile"
                       class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                        <span class="material-icons mr-2 align-middle text-sm">person</span>
                        Profile
                    </a>
                    <a href="/admin" sec:authorize="hasAuthority('ADMIN')"
                       class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                        <span class="material-icons mr-2 align-middle text-sm">store</span>
                        Manage shop
                    </a>
                    <form th:action="@{/logout}" method="post" class="block">
                        <button type="submit"
                                class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">
                            <span class="material-icons mr-2 align-middle text-sm">logout</span>
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</header>


<!-- Banner -->
<!-- Banner Slider -->
<div class="container mx-auto mt-6 px-4" style="z-index: 90">
    <div id="default-carousel" class="relative w-full" data-carousel="slide">
        <!-- Slider indicators -->
        <div class="absolute z-30 flex -translate-x-1/2 bottom-5 left-1/2 space-x-3 rtl:space-x-reverse">
            <button type="button" class="w-3 h-3 rounded-full" aria-current="true" aria-label="Slide 1"
                    data-carousel-slide-to="0"></button>
            <button type="button" class="w-3 h-3 rounded-full" aria-current="false" aria-label="Slide 2"
                    data-carousel-slide-to="1"></button>
            <button type="button" class="w-3 h-3 rounded-full" aria-current="false" aria-label="Slide 3"
                    data-carousel-slide-to="2"></button>
        </div>

        <!-- Slider items -->
        <div class="relative h-60 md:h-80 lg:h-96 overflow-hidden rounded-lg">
            <!-- Item 1 -->
            <div class="hidden duration-700 ease-in-out" data-carousel-item="active">
                <img src="https://bizweb.dktcdn.net/100/150/335/themes/805581/assets/cat-banner-1.jpg?1721533589657"
                     class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"
                     style="object-fit: none;"
                     alt="Banner 1">
            </div>
            <!-- Item 2 -->
            <div class="hidden duration-700 ease-in-out" data-carousel-item>
                <img src="https://intphcm.com/data/upload/banner-thoi-trang-dep.jpg"
                     class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"
                     style="object-fit: none;"
                     alt="Banner 2">
            </div>
            <!-- Item 3 -->
            <div class="hidden duration-700 ease-in-out" data-carousel-item>
                <img src="https://www.shutterstock.com/image-vector/horizontal-selling-banner-colored-wide-260nw-1943887528.jpg"
                     class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"
                     style="object-fit: none;"
                     alt="Banner 3">
            </div>
        </div>

        <!-- Slider controls -->
        <button type="button"
                class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                data-carousel-prev>
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                <span class="material-icons text-white">chevron_left</span>
                <span class="sr-only">Previous</span>
            </span>
        </button>
        <button type="button"
                class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                data-carousel-next>
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                <span class="material-icons text-white">chevron_right</span>
                <span class="sr-only">Next</span>
            </span>
        </button>
    </div>
</div>

<!-- Popular Products Section -->
<div class="container mx-auto px-4 mt-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Popular product</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Product Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden" th:each="product : ${popularProduct}">
            <img th:src="'/product-image/view/' + ${product.getAvatar() == null? '#' : product.getAvatar().getId()}"
                 alt="Product" class="w-full h-48 object-cover">
            <div class="p-4">
                <a class="text-lg font-bold text-gray-800 h3" th:text="${product.getName()}" th:href="'/product-detail/' + ${product.getId()}"></a>
                <p class="text-gray-600">Price: <span
                        th:text="${#numbers.formatDecimal(product.getSellPrice(), 1, 'COMMA', 0, 'POINT')} + ' đ'"></span>
                </p>
                <!-- Trong card sản phẩm, kiểm tra đăng nhập bằng Thymeleaf sec:authorize -->
                <button sec:authorize="isFullyAuthenticated()"
                        th:data-product-id="${product.id}"
                        onclick="addToCart(this)"
                        class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                    Add to cart
                </button>

                <a sec:authorize="!isFullyAuthenticated()" href="/login" target="_self"
                   class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 text-center inline-block">
                    Add to cart
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Popular Products Section -->
<div class="container mx-auto px-4 mt-8" th:each="category : ${categories}">
    <h2 class="text-2xl font-bold text-gray-800 mb-6" th:text="${category.getName()}"></h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Product Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden" th:each="product : ${category.getProducts()}">
            <img th:src="'/product-image/view/' + ${product.getAvatar() == null? '#' : product.getAvatar().getId()}"
                 alt="Product" class="w-full h-48 object-cover">
            <div class="p-4">
                <a class="text-lg font-bold text-gray-800 h3" th:text="${product.getName()}" th:href="'/product-detail/' + ${product.getId()}"></a>
                <p class="text-gray-600">Price: <span
                        th:text="${#numbers.formatDecimal(product.getSellPrice(), 1, 'COMMA', 0, 'POINT')} + ' đ'"></span>
                </p>
                <!-- Trong card sản phẩm, kiểm tra đăng nhập bằng Thymeleaf sec:authorize -->
                <button sec:authorize="isFullyAuthenticated()"
                        th:data-product-id="${product.id}"
                        onclick="addToCart(this)"
                        class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                    Add to cart
                </button>

                <a sec:authorize="!isFullyAuthenticated()" href="/login" target="_self"
                   class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 text-center inline-block">
                    Add to cart
                </a>
            </div>
        </div>
    </div>
</div>
</body>

<script sec:authorize="isFullyAuthenticated()">
    const csrfToken = document.querySelector("meta[name='_csrf']").content;
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

    function addToCart(button) {
        const productId = button.getAttribute('data-product-id');

        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [csrfHeader]: csrfToken
            },
            body: `productId=${productId}`
        })
            .then(response => response.json())
            .then(data => {
                updateCartCount(data.totalItems);
                showNotification('Added to cart successfully');
            })
            .catch(error => {
                showNotification('Error adding to cart', 'error');
            });
    }

    function updateQuantity(input) {
        const productId = input.getAttribute('data-product-id');
        const quantity = input.value;

        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [csrfHeader]: csrfToken
            },
            body: `productId=${productId}&quantity=${quantity}`
        })
            .then(response => response.json())
            .then(data => {
                location.reload();
            });
    }

    function removeItem(productId) {
        if (confirm('Are you sure you want to remove this item?')) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                },
                body: `productId=${productId}`
            })
                .then(response => response.json())
                .then(data => {
                    location.reload();
                });
        }
    }

    // Notification function
    function showNotification(message, type = 'success') {
        // Implement your notification UI here
        // Ví dụ sử dụng Toast của Flowbite
        const toast = document.createElement('div');
        toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Cart count update
    function updateCartCount(count) {
        const cartCount = document.getElementById('cartCount');
        if (cartCount) {
            cartCount.textContent = '(' + count + ')';
            if (count > 0) {
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }
    }
</script>
</html>
